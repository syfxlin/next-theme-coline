---
title: æµ…è°ˆ IO
layout: post
status: publish
published_time: 2021-02-27T00:00
modified_time: 2023-09-26T20:53
categories:
  - æŠ˜è…¾è®°å½•
tags:
  - Java
  - æµ…è°ˆ
  - IO
---
## å‰è¨€

æœ€è¿‘ä¹Ÿä¸çŸ¥é“è¯¥å­¦ä»€ä¹ˆï¼Œå¹²è„†å°±æŠŠä¹‹å‰å­¦çš„çš„ IO ç›¸å…³çš„ä¸œè¥¿ç¿»å‡ºæ¥å†™ä¸€ç¯‡æ–‡ç« å§ã€‚

## æ¦‚å¿µ

é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ **é˜»å¡ã€éé˜»å¡ã€åŒæ­¥ã€å¼‚æ­¥** è¿™äº›æ¦‚å¿µã€‚ä¹‹å‰çš„ [æµ…è°ˆå¹¶å‘ï¼šåŸºç¡€](https://blog.ixk.me/talking-about-concurrency-basics.html) ä¸€æ–‡ä¸Šæœ‰å†™äº†ç›¸å…³çš„æ¦‚å¿µï¼Œè™½ç„¶é‚£å†™çš„æ˜¯é¢å‘çº¿ç¨‹çš„æ¦‚å¿µï¼Œä¸è¿‡åœ¨ IO é€šè®¯ä¸Šä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¸å†è¯´æ˜äº†ã€‚

**åŒæ­¥ä¸å¼‚æ­¥**å…³æ³¨çš„æ˜¯**æ¶ˆæ¯é€šä¿¡æœºåˆ¶**ã€‚**é˜»å¡ä¸éé˜»å¡**å…³æ³¨çš„æ˜¯**ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æœæ—¶çš„çŠ¶æ€**ã€‚

{% table %}
- **ç±»å‹**
- **ä¸¾ä¾‹**
- **æ•ˆç‡**
---
- åŒæ­¥é˜»å¡
- åœ¨å’–å•¡åº—é‡ŒæŸœå°å‰æ’é˜Ÿç­‰ï¼Œä¸èƒ½åšå…¶ä»–çš„äº‹
- æœ€ä½
---
- åŒæ­¥éé˜»å¡
- åœ¨å’–å•¡åº—é‡Œæ’é˜Ÿç­‰æ—¶ä¸€è¾¹ç©ç€æ‰‹æœºä¸€è¾¹ä¸æ–­çš„æ£€æŸ¥æ˜¯å¦åˆ°è‡ªå·±äº†
- è¾ƒä½
---
- å¼‚æ­¥é˜»å¡
- å‘å’–å•¡åº—é‡Œçš„æœåŠ¡å‘˜ç‚¹å•ï¼Œç‚¹å®Œååœ¨è‡ªå·±çš„ä½ç½®ä¸Šç­‰å¾…ï¼Œä¸èƒ½åšå…¶ä»–çš„äº‹
- 
---
- å¼‚æ­¥éé˜»å¡
- å‘å’–å•¡åº—é‡Œçš„æœåŠ¡å‘˜ç‚¹å•ï¼Œç‚¹å®Œåæ‰“å¼€ç”µè„‘å¼€å§‹å·¥ä½œï¼Œç›´åˆ°æœåŠ¡å‘˜é€ä¸Šæ¥ã€‚
- æœ€é«˜
{% /table %}

## IO æ¨¡å‹

æœ‰äº†ä¸Šé¢çš„ä¸€äº›æ¦‚å¿µï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥çœ‹çœ‹ä»¥ä¸‹äº”ç§åœºæ™¯çš„ IO æ¨¡å‹äº†ã€‚

### é˜»å¡ IOï¼ˆBloking IOï¼‰

![](/image/posts/talking-about-io/8c4152ab-ff07-40b0-81cd-21c073884757.557x413.jpg)

### éé˜»å¡ IOï¼ˆNon-Blocking IOï¼‰

![](/image/posts/talking-about-io/6862938f-5ce7-45ec-a871-21a6eeb11268.865x564.jpg)

### IO å¤ç”¨ï¼ˆIO Multiplexingï¼‰

![](/image/posts/talking-about-io/203fc0e1-dcc2-4b02-8ee5-f1206505179f.975x606.jpg)

### ä¿¡å·é©±åŠ¨ IOï¼ˆSignal-driven IOï¼‰

![](/image/posts/talking-about-io/4fccc003-4b8c-43f4-92db-b74a696995e7.831x669.jpg)

### å¼‚æ­¥ IOï¼ˆAsynchronous IOï¼‰

![](/image/posts/talking-about-io/5d9413f4-4efc-42d1-bc1e-0cef20e177b2.880x657.jpg)

## Java ä¸­çš„ IO

### BIO

Java ä¸­çš„ BIO æ˜¯ Java ä¸­æœ€å¼€å§‹æä¾›çš„ä¸€ç§ IO æ¨¡å‹ï¼Œå¯¹åº”ä¸Šé¢äº”ç§ä¸­çš„é˜»å¡ IOã€‚åœ¨ JDK ä¸­æ˜¯åœ¨ `java.io` åŒ…ä¸­ã€‚ä½¿ç”¨èµ·æ¥æå…¶ç®€å•ä½†æ˜¯æ€§èƒ½å¹¶ä¸å¥½ã€‚é€šå¸¸é‡‡ç”¨å¦‚ä¸‹çš„æ¶æ„ï¼š

![](/image/posts/talking-about-io/16b1c289-a523-4d45-b9c8-41d5a1f6381d.948x645.jpg)

ä»¥ä¸‹æ˜¯ä¸€æ®µæ ·ä¾‹ï¼š

```java
public class BioServer {

    public static void main(final String[] args) throws Exception {
        // ç”¨ä¸€ä¸ªçº¿ç¨‹æ± å¤„ç†æ¥æ”¶åˆ°çš„è¯·æ±‚
        final ExecutorService executor = ThreadUtil.newExecutor(10);
        // ç›‘å¬ 8080 ç«¯å£
        final ServerSocket serverSocket = new ServerSocket(8080);
        while (!Thread.interrupted()) {
            // é˜»å¡å¼æ¥æ”¶è¯·æ±‚
            final Socket socket = serverSocket.accept();
            // æ¯å½“æœ‰æ–°çš„è¯·æ±‚åˆ°æ¥ï¼Œå°†å…¶æ”¾åˆ°çº¿ç¨‹æ± ä¸­å¤„ç†
            executor.submit(
                () -> {
                    try (
                        final InputStream inputStream = socket.getInputStream();
                        final OutputStream outputStream = socket.getOutputStream();
                    ) {
                        // è¾“å…¥
                        final BufferedReader reader = IoUtil.getReader(
                            inputStream,
                            StandardCharsets.UTF_8
                        );
                        while (true) {
                            final String line = reader.readLine();
                            if (line == null || "bye".equals(line)) {
                                break;
                            }
                            log.info("Input: {}", line);
                            IoUtil.writeUtf8(outputStream, false, line);
                        }
                        // è¾“å‡º

                        socket.shutdownInput();
                        socket.shutdownOutput();
                        socket.close();
                    } catch (final Exception e) {
                        log.error("Error", e);
                    }
                }
            );
        }
    }
}
```

### NIO

Java NIO æ˜¯ Java IO æ¨¡å‹ä¸­æœ€é‡è¦çš„ IO æ¨¡å‹ï¼Œåœ¨ JDK ä¸­æ˜¯åœ¨ `java.nio` åŒ…ä¸‹ï¼ŒNIO æ˜¯ New IO çš„ç®€ç§°ï¼Œä¸€èˆ¬ä¹Ÿç§°ä¸º Non-block IO ä¸è¿‡å®ƒå…¶å®å¯¹åº”çš„æ˜¯ä¸Šé¢äº”ç§ IO æ¨¡å‹ä¸­çš„éé˜»å¡ IO å’Œ IO å¤ç”¨ï¼Œå…¶æœ¬èº«æ˜¯ IO å¤ç”¨çš„ï¼Œä½†æ˜¯åŒæ—¶å¯ä»¥åˆ‡æ¢ä¸ºé˜»å¡æˆ–éé˜»å¡ä¸¤ç§æ¨¡å¼ã€‚

åœ¨ NIO ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„æ¦‚å¿µï¼š

- **ç¼“å†²åŒºï¼ˆBufferï¼‰**ï¼šç¼“å†²åŒºç”¨äºå­˜å‚¨æ•°æ®ã€‚
- **é€šé“ï¼ˆChannelï¼‰**ï¼šé€šé“ç±»ä¼¼äºä»¥å‰çš„ `InputStream` å’Œ `OutputStream` ç”¨äºè¯»å†™æ“ä½œï¼Œä¸è¿‡ä¸ä¹‹ä¸åŒçš„æ˜¯ï¼Œ`Channel` æ˜¯åŒå‘çš„ã€‚
- **å¤šè·¯å¤ç”¨å™¨ï¼ˆSelectorï¼‰**ï¼šé¡¾åæ€ä¹‰å°±æ˜¯æä¾› IO å¤ç”¨çš„ä¸œè¥¿ï¼Œé€šè¿‡æ³¨å†Œå¤šä¸ª `Channel` åˆ° `Selector` ä¸­ï¼Œå½“æŸä¸ª `Channel` å…³å¿ƒçš„äº‹ä»¶å°±ç»ªçš„æ—¶å€™ `select()` æ–¹æ³•å°±ä¼šè¿”å›ï¼Œçº¿ç¨‹å°±å¯ä»¥å¤„ç†è¿™äº›äº‹ä»¶ï¼Œäº‹ä»¶çš„ä¾‹å­æœ‰å¦‚æ–°çš„è¿æ¥è¿›æ¥ã€æ•°æ®æ¥æ”¶ç­‰ã€‚

ä¸‰è€…å…³ç³»çš„ç®€å•æ¨¡å‹ï¼š

![](/image/posts/talking-about-io/992324ce-51e2-4e8d-b3fa-e755da1a21fe.402x309.jpg)

#### Buffer

**Buffer** æœ¬è´¨ä¸Šå¯ä»¥çœ‹æˆä¸€ä¸ªå®¹å™¨ï¼Œåœ¨ NIO ä¸­å¯¹æ•°æ®çš„æ“ä½œéƒ½æ˜¯é€šè¿‡ Buffer å®Œæˆçš„ã€‚é™¤äº† `Boolean` ç±»å‹æ²¡æœ‰å¯¹åº”çš„ Buffer å¤–å…¶ä»–åŸºæœ¬ç±»å‹éƒ½æœ‰å…¶å¯¹åº”çš„ `Buffer` ç±»ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„å°±æ˜¯ `ByteBuffer` äº†ã€‚Buffer å¯ä»¥å­˜å‚¨äºå †ä¸­åŒæ—¶ä¹Ÿå¯ä»¥å­˜å‚¨äºç›´æ¥å†…å­˜é‡Œã€‚

Buffer è™½ç„¶å¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œä¸è¿‡è¯»å†™æ“ä½œå¹¶ä¸èƒ½åŒæ—¶è¿›è¡Œï¼Œæ˜¯åŠåŒå·¥çš„ï¼ŒBuffer åˆ†æˆäº†è¯»æ¨¡å¼å’Œå†™æ¨¡å¼ï¼Œå…¶åˆ‡æ¢çš„æ–¹æ³•å¦‚ä¸‹ï¼š

- **åˆå§‹çŠ¶æ€**ï¼šå†™æ¨¡å¼
- **å†™æ¨¡å¼ => è¯»æ¨¡å¼**ï¼š`flip()` æ–¹æ³•
- **è¯»æ¨¡å¼ => å†™æ¨¡å¼**ï¼š`compact()` æˆ–è€… `clear()` æ–¹æ³•
- **é‡æ–°è¯»å†™**ï¼š`rewind()` æ–¹æ³•

åœ¨ Buffer ä¸­æœ‰ 4 ä¸ªé‡è¦çš„å±æ€§ï¼Œç”¨äºç´¢å¼•å’Œæ ‡è®°ï¼š

- **å®¹é‡ï¼ˆcapacityï¼‰**ï¼šç”¨äºæ ‡è®° Buffer çš„å¤§å°ã€‚
- **ä½ç½®ï¼ˆpositionï¼‰**ï¼šç”¨äºæ ‡è®° Buffer å½“å‰è¯»æˆ–å†™çš„ä½ç½®ã€‚
- **é™åˆ¶ï¼ˆlimitï¼‰**ï¼šè¯¥å±æ€§åœ¨è¯»æ¨¡å¼ä¸‹ç­‰åŒäº `size`ï¼Œæ ‡è®°äº†æœ‰æ•ˆæ•°æ®çš„å¤§å°ã€‚åœ¨å†™æ¨¡å¼ä¸‹ç­‰åŒäº `capacity`ï¼Œæ ‡è®°äº†å¯ä»¥å†™å…¥çš„æœ€å¤§å¤§å°ã€‚ä¸€æ—¦ `position` è¶…è¿‡äº† `limit` è¿™æŠ›å‡ºå¼‚å¸¸ã€‚
- **æ ‡è®°ï¼ˆmarkï¼‰**ï¼šè°ƒç”¨ `mark()` æ ‡è®°ä¸€ä¸ªä½ç½®ï¼Œä¹‹åå¯ä»¥é€šè¿‡ `reset()` æ–¹æ³•æ¢å¤ `position` åˆ°è¯¥ä½ç½®ã€‚

ä¸¤ç§æ¨¡å¼ä¸‹çš„å±æ€§ä½ç½®å›¾ï¼š

![](/image/posts/talking-about-io/e7e8dcc9-e60d-414a-913c-91d46c5cb84a.723x424.jpg)

#### Channel

**Channel** æ˜¯ç¨‹åºè¯»å†™æ•°æ®çš„é€šé“ï¼Œé€šè¿‡ Channel æˆ‘ä»¬å¯ä»¥å°†æ•°æ®ä»æºè¯»åˆ° Bufferï¼Œä¹Ÿå¯ä»¥ä» Buffer å†™å…¥åˆ°æºé‡Œã€‚å®ƒæ˜¯å…¨åŒå·¥çš„ã€‚åœ¨ Java ä¸­å¸¸ç”¨çš„ Channel æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- **FileChannel**ï¼šç”¨äºæ–‡ä»¶çš„è¯»å†™ï¼Œ**ä¸èƒ½è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼**ã€‚
- **DatagramChannel**ï¼šç”¨äº UDP æ•°æ®è¯»å†™ã€‚
- **SocketChannel**ï¼šç”¨äº TCP æ•°æ®è¯»å†™ã€‚
- **ServerSocketChannel**ï¼šç›‘å¬ TCP è¿æ¥è¯·æ±‚ã€‚å½“æ”¶åˆ°è¯·æ±‚åè¿”å› SocketChannelã€‚

#### Selector

**Selector** æ˜¯å¤šè·¯å¤ç”¨å™¨ï¼Œä¸€èˆ¬ä¹Ÿå¯ä»¥ç›´è¯‘ä¸ºé€‰æ‹©å™¨ï¼Œå…¶åŠŸèƒ½ç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡è½®è¯¢æ³¨å†Œåœ¨å…¶ä¸Šçš„ Channel æ˜¯å¦å°±ç»ªï¼Œå¦‚æœå°±ç»ªäº†å°±ä¼šè¢«é€‰æ‹©å‡ºæ¥ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥å¯¹è¿™äº›å°±ç»ªçš„ Channel è¿›è¡Œè¯»å†™æ“ä½œäº†ã€‚Selector åœ¨ Linux ä¸Šä¾èµ–äº epollï¼Œåœ¨ Windows ä¸Šåˆ™æ˜¯ iocpã€‚Linux çš„ epoll ä½¿ç”¨çš„æ˜¯ Reactor çš„æ¨¡å¼ï¼Œåœ¨ç½‘ç»œç¼–ç¨‹ä¸­å¸¸ç”¨çš„æ˜¯ Reactor å’Œ Proactor æ¨¡å¼ï¼Œè¯¦ç»†çš„å†…å®¹å¯ä»¥å‚è€ƒ [Java NIO æµ…æ](https://tech.meituan.com/2016/11/04/nio.html)ã€‚

Selector å’Œ Channel æ˜¯é€šè¿‡ SelectionKey å…³è”èµ·æ¥çš„ï¼Œä½† Channel æ³¨å†Œåˆ° Selector ä¸­æ—¶å°±èƒ½å¾—åˆ°ä¸€ä¸ª SelectionKeyï¼Œå…¶ä½œç”¨ç›¸å½“äº IDï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„ Channelã€‚

Selector å¯ä»¥ç›‘å¬ä»¥ä¸‹ 4 ç§äº‹ä»¶ï¼š

- **OP\_CONNECT**ï¼šè¡¨ç¤ºè¿æ¥å»ºç«‹æˆåŠŸäº†ã€‚
- **OP\_ACCEPT**ï¼šç›‘å¬æ˜¯å¦æœ‰æ–°çš„è¯·æ±‚åˆ°æ¥ã€‚
- **OP\_READ**ï¼šç›‘å¬æ˜¯å¦æœ‰æ–°çš„æ•°æ®åˆ°æ¥ã€‚
- **OP\_WRITE**ï¼šç›‘å¬æ˜¯å¦å¯å†™ã€‚

ä»¥ä¸‹æ˜¯ä¸€æ®µæ ·ä¾‹ï¼š

```java
public class NioServer {

    public static void main(final String[] args) throws Exception {
        final ExecutorService executor = ThreadUtil.newExecutor(10);
        final Poller poller = new Poller();
        final Acceptor acceptor = new Acceptor(poller);
        // å¯åŠ¨ Poller
        executor.execute(poller);
        // å¯åŠ¨ Acceptor
        executor.execute(acceptor);
    }

    public static class Acceptor implements Runnable {

        private final ServerSocketChannel acceptor;
        private final Poller poller;

        public Acceptor(final Poller poller) throws IOException {
            // å¼€å¯ ServerSocketChannelï¼ŒåŒæ—¶ç»‘å®šç«¯å£
            this.acceptor = ServerSocketChannel.open();
            this.acceptor.bind(new InetSocketAddress(8080));
            this.poller = poller;
        }

        public void accept() throws IOException {
            if (this.acceptor != null && this.acceptor.isOpen()) {
                // é˜»å¡å¼ç­‰ç­‰è¯·æ±‚åˆ°æ¥
                final SocketChannel channel = this.acceptor.accept();
                this.accepted(channel);
            }
        }

        public void accepted(final SocketChannel channel) throws IOException {
            if (channel != null && channel.isOpen()) {
                // å°† SocketChannel è®¾ç½®ä¸ºéé˜»å¡ï¼Œæ³¨å†Œåˆ° Selector ä¸­
                channel.configureBlocking(false);
                this.poller.register(channel);
                // å”¤é†’ Selector
                this.poller.up();
            }
        }

        @Override
        public void run() {
            while (!Thread.interrupted()) {
                try {
                    // å¾ªç¯å¤„ç†è¯·æ±‚
                    this.accept();
                } catch (final Throwable e) {
                    log.error("Accept error", e);
                }
            }
        }
    }

    public static class Poller implements Runnable {

        private final Selector selector;

        public Poller() throws IOException {
            this.selector = Selector.open();
        }

        public void register(final SelectableChannel channel)
            throws ClosedChannelException {
            channel.register(this.selector, SelectionKey.OP_READ);
        }

        public void up() {
            this.selector.wakeup();
        }

        @Override
        public void run() {
            while (!Thread.interrupted()) {
                try {
                    // è½®è¯¢
                    final int selected = this.selector.select();
                    if (selected == 0) {
                        continue;
                    }
                    // å½“æŸ¥è¯¢åˆ°çš„æ—¶å€™å°±è¿›è¡Œå¤„ç†
                    final Iterator<SelectionKey> iterator =
                        this.selector.selectedKeys().iterator();
                    while (iterator.hasNext()) {
                        final SelectionKey key = iterator.next();
                        iterator.remove();
                        final SocketChannel channel = (SocketChannel) key.channel();
                        // è¾“å…¥
                        final ByteBuffer buffer = ByteBuffer.allocate(1024);
                        channel.read(buffer);
                        buffer.flip();
                        final String input = StrUtil
                            .str(buffer, StandardCharsets.UTF_8)
                            .trim();
                        log.info("Input: {}", input);
                        // è¾“å‡º
                        channel.write(ByteBuffer.wrap(input.getBytes()));
                    }
                } catch (final IOException e) {
                    log.error("Select error", e);
                }
            }
        }
    }
}
```

è¿™é‡Œçš„æ ·ä¾‹æ‰€ä½¿ç”¨çš„æ¶æ„ç±»ä¼¼äº Jetty å’Œ Tomcatï¼Œç”± Acceptor è´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼Œæ˜¯é˜»å¡çš„ï¼Œæ¥å—åˆ°è¯·æ±‚åå°† SocketChannel æ³¨å†Œåˆ° Poller ä¹Ÿå°±æ˜¯ Selector ä¸­ï¼Œç”± Poller è´Ÿè´£è½®è¯¢å¯è¯»å’Œå¯å†™çŠ¶æ€ã€‚æœ¬ä¾‹ä¸ºäº†ç®€å•ä¸€ç‚¹å°† IO çš„å¤„ç†æ”¾åœ¨äº† Poller ä¸­ï¼Œå®é™…çš„æ¶æ„ä¸Šåº”æ”¾åˆ°çº¿ç¨‹æ± ä¸­è¿›è¡Œå¤„ç†ï¼Œè§£æ”¾ Pollerï¼Œä½¿å…¶è¿›è¡Œä¸‹ä¸€è½®çš„è½®è¯¢ã€‚åŒæ—¶æœ¬ä¾‹åªä½¿ç”¨äº†ä¸€ä¸ª Acceptor å’Œ Pollerï¼Œå®é™…çš„æ¶æ„ä¸­ä¸€èˆ¬ä¼šè®¾ç½®å¤šä¸ªã€‚

å…·ä½“çš„æ¶æ„å¦‚ä¸‹ï¼š

![](/image/posts/talking-about-io/9e458394-71c5-41b3-8960-6bd8d76cb425.975x468.jpg)

ä¸Šé¢çš„æ¶æ„æ˜¯ç›¸å¯¹ç®€å•çš„ï¼Œä¸€èˆ¬æ¥è¯´ä¼šä½¿ç”¨æ›´å¤æ‚çš„æ–¹å¼æ¥å‹æ¦¨æ¯ä¸€åˆ†æ€§èƒ½ï¼Œæ¯”å¦‚ Jetty çš„ [EatWhatYouKill](https://blog.ixk.me/talk-about-eatwhatyoukill.html)ï¼ŒNetty çš„ EventLoop ç­‰ç­‰ã€‚

### AIO

è¯´å®Œäº† NIOï¼Œæ¥ä¸‹æ¥å°±æ˜¯ AIO äº†ï¼ŒAIO ä¸€èˆ¬ä¹Ÿç§° NIO2ï¼Œæ˜¯åœ¨ Java7 åæ–°å¢çš„å¼‚æ­¥éé˜»å¡ IO å®ç°ã€‚ä¸å†éœ€è¦ Selector è¿›è¡Œè½®è¯¢ï¼Œè€Œæ˜¯é€šè¿‡ç›‘å¬çš„æ–¹å¼ã€‚ç®€å•æ¥è¯´å°±æ˜¯ä¸å†æ˜¯**æˆ‘å»æ‹¿**ï¼Œè€Œæ˜¯**ä½ ç»™æˆ‘**ã€‚è¿™ä¸ªæ¦‚å¿µä¹Ÿæ˜¯ååº”å¼ç¼–ç¨‹ä¸­ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼ˆæ¶ˆæ¯é©±åŠ¨ï¼‰ã€‚

ä»¥ä¸‹æ˜¯ä¸€æ®µæ ·ä¾‹ä»£ç ï¼š

```java
public class AioServer {

    public static void main(final String[] args)
        throws IOException, InterruptedException {
        CountDownLatch countDownLatch = new CountDownLatch(1);
        // å¼€å¯ AsynchronousServerSocketChannel
        final AsynchronousServerSocketChannel accept = AsynchronousServerSocketChannel.open();
        accept.bind(new InetSocketAddress(8080));
        // æ¥å—è¯·æ±‚
        accept.accept(accept, new AcceptHandler());
        // ä½¿ä¸»çº¿ç¨‹ç­‰ç­‰ï¼Œå¦åˆ™ Channel ä¼šåœæ­¢ï¼Œåœ¨ç”Ÿæˆç¯å¢ƒä¸€èˆ¬ç”¨çº¿ç¨‹æ± ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚
        countDownLatch.await();
    }

    public static class AcceptHandler
        implements
            CompletionHandler<AsynchronousSocketChannel, AsynchronousServerSocketChannel> {

        @Override
        public void completed(
            AsynchronousSocketChannel channel,
            AsynchronousServerSocketChannel attachment
        ) {
            // éœ€è¦æ³¨æ„ï¼Œaccept çš„å¤„ç†å™¨åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸ºäº†èƒ½è¿ç»­æ‰§è¡Œï¼Œå°±éœ€è¦å†æ¬¡æ³¨å†Œ
            attachment.accept(attachment, this);
            // ç”³è¯· ByteBufferï¼Œå°†è¯»ä»»åŠ¡äº¤ç»™ ResultHandler å¤„ç†
            ByteBuffer buffer = ByteBuffer.allocate(1024);
            channel.read(buffer, buffer, new ResultHandler(channel));
        }

        @Override
        public void failed(
            Throwable exc,
            AsynchronousServerSocketChannel attachment
        ) {
            log.error("AcceptHandler failed", exc);
        }
    }

    public static class ResultHandler
        implements CompletionHandler<Integer, ByteBuffer> {

        private final AsynchronousSocketChannel channel;

        public ResultHandler(AsynchronousSocketChannel channel) {
            this.channel = channel;
        }

        @Override
        public void completed(Integer result, ByteBuffer buffer) {
            // è¾“å…¥
            buffer.flip();
            final String input = StrUtil
                .str(buffer, StandardCharsets.UTF_8)
                .trim();
            log.info("Input: {}", input);
            final ByteBuffer write = ByteBuffer.wrap(input.getBytes());
            // è¾“å‡º
            channel.write(
                write,
                write,
                new CompletionHandler<>() {
                    @Override
                    public void completed(
                        Integer result,
                        ByteBuffer attachment
                    ) {
                        // æœªå†™å®Œåˆ™ç»§ç»­å†™
                        if (attachment.hasRemaining()) {
                            channel.write(attachment, attachment, this);
                        } else {
                            // å¦åˆ™å°±å†æ¬¡æ³¨å†Œå¤„ç†å™¨ï¼Œè¿™æ ·å°±å¯ä»¥è¿ç»­è¯»äº†
                            ByteBuffer buffer = ByteBuffer.allocate(1024);
                            channel.read(
                                buffer,
                                buffer,
                                new ResultHandler(channel)
                            );
                        }
                    }

                    @Override
                    public void failed(Throwable exc, ByteBuffer attachment) {
                        log.error("ResultHandler failed", exc);
                    }
                }
            );
        }

        @Override
        public void failed(Throwable exc, ByteBuffer buffer) {
            log.error("ResultHandler failed", exc);
        }
    }
}
```

## ç»“è¯­

å†™äº†å¥½å‡ å¤©äº†ï¼Œæ€»ç®—æ‘¸å®Œäº†ã€‚ä¸»è¦æ˜¯æœ€è¿‘éƒ½åœ¨æŠ˜è…¾è·¯ç”±å™¨ã€æŠ˜è…¾æ‰‹æœºç­‰ç­‰ã€‚è¿˜æœ‰è¿™ä¸ªåƒåœ¾ WordPress çš„ç¼–è¾‘å™¨ï¼Œè¶Šæ¥è¶Šå¡ï¼Œåˆšå‡ºé‚£æ®µæ—¶é—´æŒºå¥½ç”¨çš„ï¼Œè¶Šå‡çº§è¶Šéš¾ç”¨ã€‚æ‰€ä»¥æ‰“ç®—æ¢æˆ Gatsby äº†ï¼Œç”±äºè¦è¿ç§»ä¸»é¢˜ï¼Œæ‰€ä»¥åº”è¯¥æ²¡é‚£ä¹ˆå¿«ä¸Šçº¿ ğŸ¤£ã€‚
