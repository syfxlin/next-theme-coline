---
title: ä½¿ç”¨ Kotlin ç¼–å†™ Spring æµ‹è¯•
layout: post
status: publish
published_time: 2021-05-23T00:00
modified_time: 2023-09-26T20:47
categories:
  - æŠ˜è…¾è®°å½•
tags:
  - Spring
  - Kotlin
  - Java
---
## å‰è¨€

é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬å†™ Spring çš„é¡¹ç›®çš„æ—¶å€™ä¼šä½¿ç”¨ Java è¯­è¨€æ¥è¿›è¡Œä¸šåŠ¡å¼€å‘ï¼ŒåŒæ—¶ä½¿ç”¨ Java æ¥è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚ä½†æ˜¯ Java ç”±äºå…¶å†—é•¿çš„ä»£ç ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™æµ‹è¯•ä»£ç çš„æ•ˆç‡å¹¶ä¸é«˜ï¼Œè€Œä¸”æˆ‘ä»¬åœ¨ç¼–å†™çš„æµ‹è¯•ä»£ç çš„æ—¶å€™é€šå¸¸ä¼šè€ƒè™‘å¤šç§æƒ…å†µï¼Œä»£ç é‡ä¹Ÿå°±è·Ÿç€æ€¥å‰§è†¨èƒ€ï¼Œå¸¦æ¥äº†ä¸å°çš„æ—¶é—´æµªè´¹ã€‚æœ€å¤´ç–¼çš„æ˜¯è¿›è¡Œ MockMvc æ¨¡æ‹Ÿè¯·æ±‚æµ‹è¯•ï¼ŒJava åœ¨ 15 ä¹‹å‰éƒ½ä¸æ”¯æŒå¤šè¡Œå­—ç¬¦ä¸²ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†æˆ‘ä»¬éœ€è¦ä¸€è¡Œä¸€è¡Œçš„è¿›è¡Œæ‹¼æ¥ï¼Œé˜…è¯»èµ·æ¥éå¸¸ä¸ç›´è§‚ï¼Œä¹Ÿä¸èƒ½å¾ˆå¥½çš„åˆ©ç”¨ Intellij IDEA çš„æ³¨å…¥è¯­è¨€ã€‚

é‚£ä¹ˆæˆ‘ä»¬æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è§£å†³è¿™äº›é—®é¢˜å‘¢ï¼Ÿ

## æ€è·¯

æˆ‘ä»¬çŸ¥é“ Java æ˜¯è¿è¡Œåœ¨ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¹‹ä¸Šçš„ï¼Œè€Œ JVM æœ¬èº«æ˜¯è¯­è¨€æ— å…³çš„ï¼Œä¸è®ºä¸Šå±‚è¯­è¨€æ˜¯ä½¿ç”¨ä½•ç§è¯­è¨€ç¼–å†™çš„ï¼Œåªè¦èƒ½ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼Œå°±èƒ½åœ¨ JVM ä¸Šè¿è¡Œã€‚æ‰€ä»¥ JVM å¹¶ä¸åªæ˜¯èƒ½è¿è¡Œ Java çš„ç¨‹åºã€‚æ¯”å¦‚ Kotlinã€Scalaã€Groovy éƒ½å¯ä»¥åœ¨ JVM ä¸Šè¿è¡Œã€‚é™¤äº†è¿è¡Œä¸åŒä»£ç å¤–ï¼Œè¯­è¨€ä¹‹é—´ä¹Ÿå¯ä»¥äº’ç›¸è°ƒç”¨ï¼Œå› ä¸ºä»£ç ç»è¿‡ç¼–è¯‘åå°±ä¸ä¸Šå±‚è¯­è¨€æ²¡æœ‰å…³ç³»äº†ï¼ˆå¤§å®¶éƒ½æ˜¯å­—èŠ‚ç ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ä¸€èµ·åˆä½œå‘¢ ğŸ¤£ï¼‰ã€‚

æ‰€ä»¥æŒ‰ç…§è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æ›´ä¸ºç›´è§‚å’Œæ–¹ä¾¿çš„è¯­è¨€æ¥ç¼–å†™æµ‹è¯•ä»£ç ã€‚å…¶ä¸­ Kotlin ä¸ Groovy å¯¹ Spring æœ‰è¾ƒå¥½çš„å…¼å®¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸¤ç§è¯­è¨€æ¥ç¼–å†™æµ‹è¯•ä»£ç ï¼ˆæœ¬æ–‡ä½¿ç”¨ Kotlinï¼‰ã€‚

## å®ç°

### åˆ›å»ºé¡¹ç›®

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åœ¨å·²æœ‰é¡¹ç›®ä¸Šä¿®æ”¹ï¼‰ï¼Œåˆ›å»ºçš„æ–¹å¼å°±å’Œçº¯ Java é¡¹ç›®ä¸€æ ·åˆ›å»ºå³å¯ã€‚

### é…ç½® Maven

åˆ›å»ºå¥½åå°±å¯ä»¥è¿›è¡Œé…ç½®äº†ï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Maven çš„ä¾èµ–å’Œæ’ä»¶ï¼Œå³ `pom.xml` æ–‡ä»¶ï¼ŒæŒ‰ç…§ [Kotlin çš„æ–‡æ¡£](https://kotlinlang.org/docs/maven.html)è¿›è¡Œæ“ä½œã€‚

é¦–å…ˆä¿®æ”¹ `properties` å±æ€§ï¼ŒåŒ Spring åˆ›å»ºåè‡ªå¸¦äº†ä¸€ä¸ª `java.version`ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ª `kotlin.version` çš„å±æ€§ã€‚å°†ç‰ˆæœ¬åˆ†ç¦»å‡ºæ¥æœ‰åŠ©äºåç»­ç»´æŠ¤ï¼š

```xml
<properties>
  <java.version>11</java.version>
  <kotlin.version>1.5.0</kotlin.version>
</properties>
```

ç„¶åæ·»åŠ  Kotlin æ ‡å‡†åº“çš„ä¾èµ–ï¼Œéœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ Kotlinï¼Œæ‰€ä»¥æŠŠ `scope` å®šä¹‰ä¸º `test`ï¼š

```xml
<dependency>
  <groupId>org.jetbrains.kotlin</groupId>
  <artifactId>kotlin-stdlib</artifactId>
  <version>${kotlin.version}</version>
  <scope>test</scope>
</dependency>
```

æ¥ç€å°±æ˜¯é…ç½® Maven æ’ä»¶ï¼Œç”¨äºç¼–è¯‘ Kotlin ä»£ç ï¼Œå°†ä»¥ä¸‹çš„ä»£ç ç›´æ¥å¤åˆ¶åˆ° `build.plugins` æ ‡ç­¾é‡Œå³å¯ã€‚æ³¨æ„ä¸è¦æŠŠ Spring çš„ Maven ç»™åˆ äº†ã€‚

```xml
<plugin>
  <groupId>org.jetbrains.kotlin</groupId>
  <artifactId>kotlin-maven-plugin</artifactId>
  <version>${kotlin.version}</version>
  <executions>
    <execution>
      <id>compile</id>
      <goals>
        <goal>compile</goal>
      </goals>
      <configuration>
        <sourceDirs>
          <sourceDir>${project.basedir}/src/main/kotlin</sourceDir>
          <sourceDir>${project.basedir}/src/main/java</sourceDir>
        </sourceDirs>
      </configuration>
    </execution>
    <execution>
      <id>test-compile</id>
      <goals>
        <goal>test-compile</goal>
      </goals>
      <configuration>
        <sourceDirs>
          <sourceDir>${project.basedir}/src/test/kotlin</sourceDir>
          <sourceDir>${project.basedir}/src/test/java</sourceDir>
        </sourceDirs>
      </configuration>
    </execution>
  </executions>
</plugin>
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-compiler-plugin</artifactId>
  <version>3.5.1</version>
  <executions>
    <!-- Replacing default-compile as it is treated specially by maven -->
    <execution>
      <id>default-compile</id>
      <phase>none</phase>
    </execution>
    <!-- Replacing default-testCompile as it is treated specially by maven -->
    <execution>
      <id>default-testCompile</id>
      <phase>none</phase>
    </execution>
    <execution>
      <id>java-compile</id>
      <phase>compile</phase>
      <goals>
        <goal>compile</goal>
      </goals>
    </execution>
    <execution>
      <id>java-test-compile</id>
      <phase>test-compile</phase>
      <goals>
        <goal>testCompile</goal>
      </goals>
    </execution>
  </executions>
</plugin>
```

æ­¤æ—¶è¯¥é¡¹ç›®å·²ç»å…·å¤‡äº†ç¼–è¯‘ Kotlin çš„èƒ½åŠ›ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å¯¼å…¥ä»»ä½• Kotlin çš„æµ‹è¯•åº“ï¼Œåªä½¿ç”¨ JUnit çš„è¯å¹¶ä¸æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸€äº›æ–­è¨€åº“ç”¨äºä¾¿æ·çš„ç¼–å†™æµ‹è¯•ï¼š

```xml
<dependency>
  <groupId>io.kotest</groupId>
  <artifactId>kotest-runner-junit5-jvm</artifactId>
  <version>4.5.0</version>
  <scope>test</scope>
</dependency>
<dependency>
  <groupId>io.kotest</groupId>
  <artifactId>kotest-assertions-core-jvm</artifactId>
  <version>4.5.0</version>
  <scope>test</scope>
</dependency>
<dependency>
  <groupId>io.kotest</groupId>
  <artifactId>kotest-assertions-json</artifactId>
  <version>4.5.0</version>
  <scope>test</scope>
</dependency>
```

Kotest ä¹Ÿæ˜¯ä¸€ä¸ªå’Œ JUnit ç±»ä¼¼çš„å•å…ƒæµ‹è¯•å·¥å…·ï¼Œä¸è¿‡æˆ‘ä»¬åªä¼šç”¨åˆ°æ–­è¨€çš„åŠŸèƒ½ï¼Œå› ä¸º Kotest è™½ç„¶æœ‰ Spring æµ‹è¯•çš„æ”¯æŒï¼Œä¸è¿‡å¯èƒ½ä¼šé‡åˆ°å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼ˆè‡³å°‘æˆ‘æ˜¯æ²¡å¼„å¥½ï¼Œè¿˜ä¸å¦‚ç›´æ¥ç”¨ JUnitï¼‰ã€‚

### ç¼–å†™ä¸šåŠ¡

é…ç½®å¥½æµ‹è¯•ç¯å¢ƒäº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç¼–å†™ä¸šåŠ¡ä»£ç äº†ã€‚æœ¬æ–‡å°±ä¸ç”¨å®é™…çš„é¡¹ç›®è¿›è¡Œæµ‹è¯•äº†ï¼Œå°±éšä¾¿å†™äº†ä¸€ä¸ªæ§åˆ¶å™¨å’Œå‡ ä¸ªå‡½æ•°ï¼š

```java
@RestController
public class IndexController {

    @GetMapping("/index")
    public String get() {
        return "index";
    }

    @PostMapping("/index")
    public String post(@RequestParam("value") final String value) {
        return value;
    }

    @PutMapping("/json")
    public JsonNode json(@RequestBody JsonNode node) {
        return node;
    }
}
```

```java
@Service
public class UserService {

    public String getUserName(final Long id) {
        return "username: " + id;
    }
}
```

### ç¼–å†™æµ‹è¯•

æœ‰äº†ä¸šåŠ¡ä»£ç å°±å¯ä»¥è¿›è¡Œæµ‹è¯•äº†ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ `test` æ–‡ä»¶å¤¹é‡Œåˆ›å»ºä¸€ä¸ª `kotlin` æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾ Kotlin çš„æµ‹è¯•ä»£ç ï¼ˆç›´æ¥åœ¨ java æ–‡ä»¶å¤¹é‡Œå†™åº”è¯¥ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡è¿˜æ˜¯è§„èŒƒä¸€ç‚¹å¥½ï¼‰ï¼Œç„¶åå°† `kotlin` è®¾ä¸ºæµ‹è¯•æ–‡ä»¶å¤¹ï¼ˆIDEA ä¸ä¼šè‡ªåŠ¨è¯†åˆ«ï¼‰

![](/image/posts/writing-spring-tests-with-kotlin/15be6816-8448-4aa4-8726-2d3046466d4a.1024x844.jpg)

ç”¨äºæµ‹è¯• `UserService` çš„ä»£ç å¦‚ä¸‹ï¼š

```kotlin
@SpringBootTest
class UserServiceTest {
    @Autowired
    private lateinit var userService: UserService

    @Test
    fun getUserName() {
        userService.getUserName(1) shouldBe "username: 1"
        userService.getUserName(2) should {
            it shouldBe "username: 2"
            it.length shouldBe 11
        }
    }
}
```

å¯ä»¥çœ‹åˆ° Kotlin æä¾›äº†éå¸¸å¤šçš„è¯­æ³•ç³–ï¼Œåœ¨æµ‹è¯•çš„æ—¶å€™å¯ä»¥é¿å…ç¼–å†™å‡ºä¸ç›´è§‚ä¸”é‡å¤çš„ä»£ç ã€‚ç›¸æ¯”ä¹‹ä¸‹ Java çš„ä»£ç å°±æ˜¾å¾—æœ‰äº›ä¸å¤ªç›´è§‚äº†ï¼š

```java
@SpringBootTest
class UserServiceTest {

    @Autowired
    private UserService userService;

    @Test
    void getUserName() {
        assertEquals("username: 1", userService.getUserName(1L));
        final String userName = userService.getUserName(2L);
        assertEquals("username: 2", userName);
        assertEquals(11, userName.length());
    }
}
```

### MockMvc æµ‹è¯•

å…¶å®å¯¹äºæ™®é€šçš„å•å…ƒæµ‹è¯•ä»£ç æ˜¯ Java è¿˜å¥½ï¼Œä½†æ˜¯åœ¨ MockMvc çš„æµ‹è¯•ä¸­ Kotlin çš„ä¼˜åŠ¿å°±ä½“ç°å‡ºæ¥äº†ã€‚Spring ä¸º Kotlin æä¾›äº†å¤§é‡çš„ DSL æ”¯æŒï¼š

```kotlin
@WebMvcTest(IndexController::class)
class MockMvcTest {
    @Autowired
    private lateinit var mockMvc: MockMvc

    @Test
    fun get() {
        mockMvc.get("/index").andExpect {
            status { isOk() }
            content {
                contentTypeCompatibleWith("text/plain")
                string("index")
            }
        }
    }

    @Test
    fun post() {
        mockMvc.post("/index") {
            param("value", "test value")
        }.andExpect {
            status { isOk() }
            content {
                string("test value")
            }
        }.andDo {
            print()
            handle {
                println(it.response.characterEncoding)
            }
        }
    }

    @Test
    fun json() {
        mockMvc.put("/json") {
            contentType = MediaType.APPLICATION_JSON
            accept = MediaType.APPLICATION_JSON
            content = """
                {
                  "key": "value",
                  "key2": {
                    "key3": [1, 2, 3]
                  }
                }
            """.trimIndent()
        }.andExpect {
            status { isOk() }
            content {
                contentType(MediaType.APPLICATION_JSON)
            }
            jsonPath("$.key") {
                value("value")
            }
            jsonPath("$.key2.key3.length()") {
                value(3)
            }
        }
    }
}
```

## ç»“è¯­

æœ€è¿‘éƒ½åœ¨å†™äº‘ç¬”è®°çš„é¡¹ç›®ï¼ˆå¾®æœåŠ¡ï¼‰ï¼Œä¹‹åæ‰“ç®—åšæˆæ¯•è®¾ï¼Œä¹Ÿç®—åŠ ä¸ªèƒ½æ‹¿å¾—å‡ºæ‰‹çš„é¡¹ç›®ï¼Œæœ¬æ–‡çš„æƒ³æ³•ä¹Ÿæ˜¯åœ¨å¤´ç–¼ MockMvc æµ‹è¯•çš„ Json è¯·æ±‚å‚æ•°å®åœ¨éš¾ä»¥é˜…è¯»ï¼Œçªç„¶æƒ³åˆ°çš„ï¼Œå¦‚æœä½ ä¹Ÿæœ‰ç›¸å…³çš„çƒ¦æ¼çš„æ—¶å€™ä¹Ÿå¯ä»¥è¯•è¯•ï¼Œä¸è¿‡å¤§å¤šæ•°å¼€å‘è€…åº”è¯¥è¿˜æ˜¯ä¼šä½¿ç”¨ Java æ¥ç¼–å†™æµ‹è¯•ä»£ç å§ï¼Œæ¯•ç«Ÿæ›´åŠ ç†Ÿæ‚‰ ğŸ˜‚ã€‚

å‰ä¸ä¹…æ‹¿åˆ°äº†è¶‹åŠ¿ç§‘æŠ€çš„æš‘å‡å®ä¹  offerï¼Œä¸ç”¨å†æ‹…å¿ƒæš‘å‡æ²¡åœ°æ–¹å®ä¹ äº† ğŸ¤£ï¼Œåªä¸è¿‡åº”è¯¥ä¼šæŒºæ™šæ‰æ”¾å‡ï¼Œéš¾å— ğŸ˜¥ã€‚å¯ä»¥ç¨å¾®æ‘¸é±¼ä¸‹äº†ï¼Œä¸è¿‡åé¢è¿˜æœ‰ç§‹æ‹›è¿˜æ˜¯è¦æ¥ç€å‡†å¤‡å‘€ã€‚
